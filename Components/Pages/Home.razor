@page "/"
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject JobLevelDictionary JobLevelDictionary
@rendermode InteractiveServer


<h1>Generate a job description</h1>
<div class="mt-3">
    <label for="jobFamilySelection">Select a Job Family</label>
    <select id="jobFamilySelection" @bind="selectedJobFamilyId" @bind:after="OnJobFamilySelected">
        <option disabled selected value="">-- Select Job Family --</option>
        @foreach (var family in jobFamilies)
        {
            <option value="@family.JobFamilyId">@family.JobFamilyName</option>
        }
    </select>
</div>
@if (jobTitles.Any())
{
    <div class="mt-3">
        <label for="jobTitleSelection">Select a Job Title</label>
        <select id="jobTitleSelection" @bind="selectedJobTitleId" @bind:after="OnJobTitleSelected">
            <option disabled selected value="">-- Select Job Title --</option>
            @foreach (var title in jobTitles)
            {
                <option value="@title.JobTitleId">
                    Job Level - @title.JobLevel: @title.JobTitleName
                </option>
            }
        </select>
    </div>
}


@if (selectedJobTitleId is not null)
{
    <label for="KnowledgeAndSkills"><strong>Knowledge and Skills</strong></label>
    <ul id="KnowledgeAndSkills" class="mt-3">
        @for (int i = 0; i < knowledgeAndSkills.Count; i++)
        {
            var index = i;
            <li class="mb-1">
                <textarea @bind="knowledgeAndSkills[index]" rows="1" cols="60"
                    placeholder="Describe knowledge or skill..."></textarea>
                <button type="button" @onclick="() => RemoveKnowledgeSkill(index)">Remove</button>
            </li>
        }
        <button type="button" @onclick="AddKnowledgeSkill">+ Add Requirement</button>
    </ul>
    <div class="mt-3">
        <label for="radioGroup"><strong>Is a People Manager?</strong></label>
        <InputRadioGroup id="radioGroup" @bind-value="isManager">
            <InputRadio value="true" id="managerYes" />
            <label for="managerYes">Yes</label>

            <InputRadio value="false" id="managerNo" />
            <label for="managerNo">No</label>
        </InputRadioGroup>
    </div>

    <div class="mt-3">
        <label><strong>Job Purpose</strong></label><br />
        <textarea @bind="jobPurpose" rows="4" cols="60" placeholder="Describe job purpose..."></textarea>
    </div>

    <label for="keyAccountabilities"><strong>Key Accountabilities</strong></label>
    <ul id="keyAccountabilities" class="mt-3">
        @for (int i = 1; i < keyAccountabilities.Count; i++)
        {
            var index = i;
            <li class="mb-2">
                <textarea @bind="keyAccountabilities[index]" rows="1" cols="60"
                    placeholder="Describe accountability..."></textarea>
                <button type="button" @onclick="() => RemoveAccountability(index)">Remove</button>
            </li>
        }

        <button type="button" @onclick="AddAccountability">+ Add Accountability</button>
    </ul>

    <div class="mt-4">
        <button @onclick="GenerateDoc">Generate Document</button>
    </div>
}

@code {
    private List<JobFamily> jobFamilies = new();
    private int? selectedJobFamilyId;

    private List<JobTitle> jobTitles = new();
    private int? selectedJobTitleId;
    private bool isManager;
    private string jobPurpose;
    private List<string> keyAccountabilities = new();
    private List<string> knowledgeAndSkills = new();


    protected override async Task OnInitializedAsync()
    {
        jobFamilies = await Db.JobFamilies.ToListAsync();
    }

    private async Task OnJobFamilySelected()
    {
        jobTitles = await Db.JobTitles
        .Where(t => t.JobFamilyId == selectedJobFamilyId)
        .OrderBy(t => t.JobLevel)
        .ToListAsync();

        Console.WriteLine($"Total job titles: {jobTitles.Count}");

        selectedJobTitleId = null;
    }

    private async Task OnJobTitleSelected()
    {
        var title = await Db.JobTitles.FindAsync(selectedJobTitleId);

        if (title is not null)
        {
            var levelName = $"Job Level - {title.JobLevel}";
            knowledgeAndSkills = JobLevelDictionary.GetValueOrDefault(levelName, new()).ToList();
        }
    }


    private void AddKnowledgeSkill() => knowledgeAndSkills.Add(string.Empty);
    private void RemoveKnowledgeSkill(int index)
    {
        if (index >= 0 && index < knowledgeAndSkills.Count)
            knowledgeAndSkills.RemoveAt(index);
    }

    private void AddAccountability() => keyAccountabilities.Add(string.Empty);
    private void RemoveAccountability(int index)
    {
        if (index >= 0 && index < keyAccountabilities.Count)
            keyAccountabilities.RemoveAt(index);
    }

    private async Task GenerateDoc() { }
}
