@page "/"
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject IJobLevelService JobLevelService
@inject JobLevelDictionary JobLevelDictionary
@rendermode InteractiveServer


<h1>Generate a job description</h1>
<div class="mt-3">
    <label for="jobFamilySelection">Select a Job Family</label>
    <select id="jobFamilySelection" @bind="selectedJobFamilyId">
        <option disabled selected value="">-- Select Job Family --</option>
        @foreach (var family in jobFamilies)
        {
            <option value="@family.JobFamilyId">@family.JobFamilyName</option>
        }
    </select>
</div>
@if (selectedJobFamilyId is not null)
{
    <div class="mt-3">
        <label for="jobLevelSelection">Select a Job Level</label>
        <select id="jobLevelSelection" @bind="selectedJobLevelId" @bind:after="LoadBaseSkills">
            <option disabled selected value="">-- Select Job Level --</option>
            @foreach (var (id, name) in JobLevelService.GetLevelsForFamily(selectedJobFamilyId.Value))
            {
                <option value="@id">@name</option>
            }
        </select>
    </div>
}

@if (selectedJobLevelId is not null)
{
    <label for="KnowledgeAndSkills"><strong>Knowledge and Skills</strong></label>
    <ul id="KnowledgeAndSkills" class="mt-3">
        @for (int i = 0; i < knowledgeAndSkills.Count; i++)
        {
            var index = i;
            <li class="mb-1">
                <textarea @bind="knowledgeAndSkills[index]" rows="1" cols="60"
                    placeholder="Describe knowledge or skill..."></textarea>
                <button type="button" @onclick="() => RemoveKnowledgeSkill(index)">Remove</button>
            </li>
        }
        <button type="button" @onclick="AddKnowledgeSkill">+ Add Requirement</button>
    </ul>
    <div class="mt-3">
        <label for="radioGroup"><strong>Is a People Manager?</strong></label>
        <InputRadioGroup id="radioGroup" @bind-value="isManager">
            <InputRadio value="true" id="managerYes" />
            <label for="managerYes">Yes</label>

            <InputRadio value="false" id="managerNo" />
            <label for="managerNo">No</label>
        </InputRadioGroup>
    </div>

    <div class="mt-3">
        <label><strong>Job Purpose</strong></label><br />
        <textarea @bind="jobPurpose" rows="4" cols="60" placeholder="Describe job purpose..."></textarea>
    </div>

    <label for="keyAccountabilities"><strong>Key Accountabilities</strong></label>
    <ul id="keyAccountabilities" class="mt-3">
        @for (int i = 1; i < keyAccountabilities.Count; i++)
        {
            var index = i;
            <li class="mb-2">
                <textarea @bind="keyAccountabilities[index]" rows="1" cols="60"
                    placeholder="Describe accountability..."></textarea>
                <button type="button" @onclick="() => RemoveAccountability(index)">Remove</button>
            </li>
        }

        <button type="button" @onclick="AddAccountability">+ Add Accountability</button>
    </ul>

    <div class="mt-4">
        <button @onclick="GenerateDoc">Generate Document</button>
    </div>
}

@code {
    private List<JobFamily> jobFamilies = new();

    private int? selectedJobFamilyId;
    private int? selectedJobLevelId;
    private bool isManager;
    private string jobPurpose;
    private List<string> keyAccountabilities = new();
    private List<string> knowledgeAndSkills;


    protected override async Task OnInitializedAsync()
    {
        jobFamilies = await Db.JobFamilies.ToListAsync();
    }

    private void LoadBaseSkills()
    {
        if (selectedJobLevelId is not null)
        {
            var levelName = JobLevelService.GetNameForLevel(selectedJobLevelId.Value);
            knowledgeAndSkills = JobLevelDictionary.GetValueOrDefault(levelName, new()).ToList();
        }
        else
        {
            knowledgeAndSkills.Clear();
        }
    }


    private void AddKnowledgeSkill() => knowledgeAndSkills.Add(string.Empty);
    private void RemoveKnowledgeSkill(int index)
    {
        if (index >= 0 && index < knowledgeAndSkills.Count)
            knowledgeAndSkills.RemoveAt(index);
    }

    private void AddAccountability() => keyAccountabilities.Add(string.Empty);
    private void RemoveAccountability(int index)
    {
        if (index >= 0 && index < keyAccountabilities.Count)
            keyAccountabilities.RemoveAt(index);
    }

    private async Task GenerateDoc() { }
}
